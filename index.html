<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stop Tabac - Économies</title>
  <meta name="theme-color" content="#466781">
  <style>
    :root{
      --bg:#0f1720; --card:#121c27; --muted:#a9b4c2; --text:#eef3f8; --accent:#466781; --line:rgba(255,255,255,.08);
    }
    body{ margin:0; font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial; background:linear-gradient(180deg,#0b1118, var(--bg)); color:var(--text); }
    .wrap{ max-width:920px; margin:0 auto; padding:18px; }
    h1{ font-size:1.2rem; margin:10px 0 14px; font-weight:800; }
    .card{ background:rgba(18,28,39,.92); border:1px solid var(--line); border-radius:14px; padding:14px; margin:12px 0; }
    .grid{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:720px){ .grid{ grid-template-columns:1fr 1fr; } }
    label{ display:block; font-size:.86rem; color:var(--muted); margin:0 0 6px; font-weight:650; }
    input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:#0b1118; color:var(--text); font-size:1rem; outline:none;
    }
    input:focus{ border-color:rgba(70,103,129,.65); box-shadow:0 0 0 3px rgba(70,103,129,.25); }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      border:0; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer;
      background:var(--accent); color:white;
    }
    button.secondary{ background:transparent; border:1px solid var(--line); color:var(--text); }
    .kpi3{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width:720px){ .kpi3{ grid-template-columns:repeat(3,1fr); } }
    .box{ background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .big{ font-size:1.45rem; font-weight:900; margin-top:4px; }
    .small{ font-size:.85rem; color:var(--muted); line-height:1.35; }
    .sub{ margin-top:6px; font-size:.85rem; color:var(--muted); }
    .row2{ display:grid; gap:10px; grid-template-columns:1fr; margin-top:10px; }
    @media (min-width:720px){ .row2{ grid-template-columns:1fr 1fr; } }
    .collapsible__head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer; user-select:none;
    }
    .pill{
      font-size:.8rem; font-weight:800; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text);
      white-space:nowrap;
    }
    .chev{ opacity:.85; font-weight:900; }
    .hidden{ display:none !important; }
    .warn{ color:#ffd28a; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Stop tabac - économies & suivi</h1>

    <!-- KPIs -->
    <div class="card">
      <!-- 3 premiers box -->
      <div class="kpi3">
        <div class="box">
          <div class="small">Temps sans cigarette</div>
          <div class="big" id="kpiTime">-</div>
        </div>

        <div class="box">
          <div class="small">Économies nettes</div>
          <div class="big" id="kpiNet">-</div>
          <div class="sub"><span id="kpiNetDay">-</span> / jour</div>
        </div>

        <div class="box">
          <div class="small">Cigarettes évitées</div>
          <div class="big" id="kpiCigs">-</div>
          <div class="sub"><span id="kpiCigsDay">-</span> / jour</div>
        </div>
      </div>

      <!-- Temps de vie stat (pleine largeur, toujours affiché) -->
      <div class="box" style="margin-top:10px">
        <div class="small">Temps de vie gagné</div>
        <div class="big" id="kpiLife">-</div>
      </div>

      <!-- 2 boxes dessous -->
      <div class="row2">
        <div class="box">
          <div class="small">Dépenses “avant” (tabac + vapote)</div>
          <div class="big" id="kpiBefore">-</div>
          <div class="sub"><span id="kpiBeforeDay">-</span> / jour</div>
        </div>

        <div class="box">
          <div class="small">Dépenses “maintenant” (vapote)</div>
          <div class="big" id="kpiNow">-</div>
          <div class="sub"><span id="kpiNowDay">-</span> / jour</div>
        </div>
      </div>
    </div>

    <!-- Paramètres (collapsible) -->
    <div class="card" id="paramsCard">
      <div class="collapsible__head" id="paramsToggle" role="button" aria-expanded="true">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="font-weight:900;">Paramètres</div>
          <span class="pill" id="paramsStatus">Ouvert</span>
        </div>
        <div class="chev" id="paramsChev">▾</div>
      </div>

      <div id="paramsBody" style="margin-top:12px;">
        <div class="grid">
          <div>
            <label>Date/heure d’arrêt</label>
            <input id="quitAt" type="datetime-local">
          </div>

          <div>
            <label>Prix d’un paquet (€)</label>
            <input id="packPrice" type="number" min="0" step="0.01" value="12.00">
          </div>

          <div>
            <label>Cigarettes par paquet</label>
            <input id="cigsPerPack" type="number" min="1" step="1" value="20">
          </div>

          <div>
            <label>Ta conso avant (cigarettes / jour)</label>
            <input id="cigsPerDay" type="number" min="0" step="1" value="17">
          </div>

          <div>
            <label>Vapote AVANT (€/jour)</label>
            <input id="vapeBeforePerDay" type="number" min="0" step="0.01" value="0.00">
          </div>

          <div>
            <label>Vapote MAINTENANT (€/jour)</label>
            <input id="vapeNowPerDay" type="number" min="0" step="0.01" value="2.00">
          </div>
        </div>

        <div class="btns" style="margin-top:12px">
          <button id="save">Enregistrer</button>
          <button class="secondary" id="reset">Réinitialiser</button>
        </div>

        <div class="small" style="margin-top:10px">
          Les dépenses “avant” incluent tabac + vapote avant. Les dépenses “maintenant” incluent uniquement la vapote (tabac=0).
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const MINUTES_PER_CIG_APPROX = 7;

  function fmtEUR(x){
    return new Intl.NumberFormat('fr-FR', { style:'currency', currency:'EUR' }).format(x);
  }
  function fmtNum(x){
    return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 2 }).format(x);
  }
  function pad2(n){ return String(n).padStart(2,'0'); }

  function defaultQuitAt(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function setParamsOpen(isOpen){
    const body = $('paramsBody');
    const status = $('paramsStatus');
    const chev = $('paramsChev');

    body.classList.toggle('hidden', !isOpen);
    status.textContent = isOpen ? 'Ouvert' : 'Fermé';
    chev.textContent = isOpen ? '▾' : '▸';

    const data = JSON.parse(localStorage.getItem('stopTabac') || '{}');
    data.paramsOpen = isOpen;
    localStorage.setItem('stopTabac', JSON.stringify(data));

    $('paramsToggle').setAttribute('aria-expanded', String(isOpen));
  }

  function load(){
    const data = JSON.parse(localStorage.getItem('stopTabac') || '{}');

    $('quitAt').value = data.quitAt || defaultQuitAt();
    $('packPrice').value = data.packPrice ?? 12.00;
    $('cigsPerPack').value = data.cigsPerPack ?? 20;
    $('cigsPerDay').value = data.cigsPerDay ?? 12;
    $('vapeBeforePerDay').value = data.vapeBeforePerDay ?? 2.00;
    $('vapeNowPerDay').value = data.vapeNowPerDay ?? 4.00;

    const paramsOpen = (data.paramsOpen ?? true) === true;
    setParamsOpen(paramsOpen);
  }

  function save(closeAfter=true){
    const data = {
      quitAt: $('quitAt').value,
      packPrice: Number($('packPrice').value || 0),
      cigsPerPack: Number($('cigsPerPack').value || 20),
      cigsPerDay: Number($('cigsPerDay').value || 0),
      vapeBeforePerDay: Number($('vapeBeforePerDay').value || 0),
      vapeNowPerDay: Number($('vapeNowPerDay').value || 0),
      paramsOpen: false
    };

    if(!closeAfter){
      const prev = JSON.parse(localStorage.getItem('stopTabac') || '{}');
      data.paramsOpen = (prev.paramsOpen ?? true);
    }

    localStorage.setItem('stopTabac', JSON.stringify(data));
    render();

    if(closeAfter){
      setParamsOpen(false);
    }
  }

  function reset(){
    localStorage.removeItem('stopTabac');
    load();
    render();
  }

  function diffParts(ms){
    const totalSec = Math.max(0, Math.floor(ms/1000));
    const days = Math.floor(totalSec / 86400);
    const hrs = Math.floor((totalSec % 86400) / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    return { days, hrs, mins };
  }

  function render(){
    const quitAtStr = $('quitAt').value;
    const quitAt = new Date(quitAtStr);
    const now = new Date();
    const elapsedMs = now - quitAt;

    if(!quitAtStr || isNaN(quitAt.getTime()) || elapsedMs < 0){
      ['kpiTime','kpiNet','kpiBefore','kpiNow','kpiCigs','kpiLife'].forEach(id => $(id).textContent='-');
      ['kpiNetDay','kpiBeforeDay','kpiNowDay','kpiCigsDay'].forEach(id => $(id).textContent='-');
      return;
    }

    const {days, hrs, mins} = diffParts(elapsedMs);
    $('kpiTime').textContent = `${days} j ${hrs} h ${mins} min`;

    const packPrice = Math.max(0, Number($('packPrice').value || 0));
    const cigsPerPack = Math.max(1, Number($('cigsPerPack').value || 20));
    const cigsPerDay = Math.max(0, Number($('cigsPerDay').value || 0));
    const vapeBeforePerDay = Math.max(0, Number($('vapeBeforePerDay').value || 0));
    const vapeNowPerDay = Math.max(0, Number($('vapeNowPerDay').value || 0));

    const elapsedDays = elapsedMs / (1000*60*60*24);

    // Quantité évitée
    const cigsAvoided = Math.max(0, cigsPerDay * elapsedDays);

    // Coût tabac évité
    const pricePerCig = packPrice / cigsPerPack;
    const tobaccoSaved = cigsAvoided * pricePerCig;

    // Dépenses cumulées
    const beforeCost = tobaccoSaved + (vapeBeforePerDay * elapsedDays); // tabac + vapote avant
    const nowCost = (vapeNowPerDay * elapsedDays);                      // vapote maintenant (tabac = 0)
    const netSaved = beforeCost - nowCost;

    // KPIs cumulés
    $('kpiCigs').textContent = Math.floor(cigsAvoided).toLocaleString('fr-FR');
    $('kpiBefore').textContent = fmtEUR(beforeCost);
    $('kpiNow').textContent = fmtEUR(nowCost);
    $('kpiNet').textContent = fmtEUR(netSaved);

    // KPIs quotidiens
    $('kpiCigsDay').textContent = fmtNum(cigsPerDay);

    const beforePerDay = (cigsPerDay * pricePerCig) + vapeBeforePerDay;
    const nowPerDay = vapeNowPerDay;
    const netPerDay = beforePerDay - nowPerDay;

    $('kpiBeforeDay').textContent = fmtEUR(beforePerDay);
    $('kpiNowDay').textContent = fmtEUR(nowPerDay);
    $('kpiNetDay').textContent = fmtEUR(netPerDay);

    // Temps de vie stat (toujours affiché)
    const minsLife = cigsAvoided * MINUTES_PER_CIG_APPROX;
    const total = Math.floor(minsLife);
    const d = Math.floor(total / 1440);
    const h = Math.floor((total % 1440) / 60);
    const m = total % 60;
    $('kpiLife').textContent = `${d} j ${h} h ${m} min`;
  }

  // UI
  $('paramsToggle').addEventListener('click', () => {
    const data = JSON.parse(localStorage.getItem('stopTabac') || '{}');
    const isOpen = (data.paramsOpen ?? true) === true;
    setParamsOpen(!isOpen);
  });

  $('save').addEventListener('click', () => save(true));
  $('reset').addEventListener('click', reset);

  // Rendu live (sans auto-fermeture)
  ['quitAt','packPrice','cigsPerPack','cigsPerDay','vapeBeforePerDay','vapeNowPerDay'].forEach(id=>{
    $(id).addEventListener('input', render);
    $(id).addEventListener('change', () => save(false));
  });

  load();
  render();
  setInterval(render, 1000 * 10);
</script>
</body>
</html>
